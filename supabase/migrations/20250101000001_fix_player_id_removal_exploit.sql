-- =====================================================
-- MIGRAZIONE: Fix Player ID Removal Exploit
-- Data: 2025-01-01
-- Descrizione: Corregge il bug che permetteva di bypassare il limite
--              di 3 cambi rimuovendo e reimpostando l'ID
-- =====================================================
-- 
-- ⚠️ PROBLEMA RISOLTO:
--   - Rimuovere l'ID (NULL) resettava il contatore a 0
--   - Reimpostare l'ID (da NULL a valore) veniva trattato come "initial"
--   - Questo permetteva cambi illimitati
-- 
-- ✅ SOLUZIONE:
--   - Non resettare contatore/lock quando si rimuove l'ID se ha già fatto 3 cambi
--   - Distinguere tra "prima impostazione mai" e "reimpostazione dopo rimozione"
--   - Bloccare rimozione se ha già fatto 3 cambi
-- =====================================================

-- =====================================================
-- CORREZIONE TRIGGER: check_player_id_change_limit()
-- =====================================================

CREATE OR REPLACE FUNCTION public.check_player_id_change_limit()
RETURNS TRIGGER AS $$
DECLARE
  current_count INTEGER;
  old_id BIGINT;
  has_ever_set_id BOOLEAN;
BEGIN
  -- Se dota_account_id non cambia, non fare nulla
  IF OLD.dota_account_id = NEW.dota_account_id THEN
    RETURN NEW;
  END IF;

  -- Verifica se l'utente ha mai impostato un ID (controlla storico)
  -- Se ha entry nello storico, anche se ora è NULL, ha già impostato un ID prima
  SELECT EXISTS(
    SELECT 1 FROM public.player_id_history 
    WHERE user_id = NEW.id 
    LIMIT 1
  ) INTO has_ever_set_id;

  -- Se sta rimuovendo l'ID (NULL)
  IF NEW.dota_account_id IS NULL THEN
    -- Se ha già fatto 3 cambi, NON permettere la rimozione (mantieni lock e contatore)
    current_count := COALESCE(OLD.dota_account_id_change_count, 0);
    IF current_count >= 3 OR OLD.dota_account_id_locked = TRUE THEN
      RAISE EXCEPTION 'Player ID è bloccato. Non puoi rimuovere il Player ID dopo aver fatto 3 cambi. Contatta il supporto.';
    END IF;
    
    -- Se non ha fatto 3 cambi, permetti rimozione (reset contatore solo se non ha mai impostato ID)
    -- Se ha già impostato un ID prima, mantieni il contatore per prevenire exploit
    IF has_ever_set_id THEN
      -- Ha già impostato un ID prima, mantieni il contatore (non resettare)
      -- Questo previene l'exploit di rimuovere e reimpostare
      NEW.dota_account_id_last_changed_at := NULL;
      -- NON resettare change_count e locked
    ELSE
      -- Prima volta che rimuove (non ha mai impostato ID), reset OK
      NEW.dota_account_id_change_count := 0;
      NEW.dota_account_id_last_changed_at := NULL;
      NEW.dota_account_id_locked := FALSE;
    END IF;
    
    RETURN NEW;
  END IF;

  -- Se sta impostando per la prima volta (da NULL a valore)
  IF OLD.dota_account_id IS NULL AND NEW.dota_account_id IS NOT NULL THEN
    -- Se ha già impostato un ID prima (ha entry nello storico), è una REIMPOSTAZIONE
    -- Trattala come un cambio, non come "initial"
    IF has_ever_set_id THEN
      -- Reimpostazione dopo rimozione: conta come cambio
      current_count := COALESCE(OLD.dota_account_id_change_count, 0);
      
      -- Controlla se è già bloccato
      IF OLD.dota_account_id_locked = TRUE THEN
        RAISE EXCEPTION 'Player ID è bloccato. Hai già cambiato 3 volte. Contatta il supporto per sbloccare.';
      END IF;
      
      -- Se ha già fatto 3 cambi, blocca
      IF current_count >= 3 THEN
        NEW.dota_account_id_locked := TRUE;
        RAISE EXCEPTION 'Hai raggiunto il limite di 3 cambi Player ID. Contatta il supporto per sbloccare.';
      END IF;
      
      -- Incrementa contatore
      NEW.dota_account_id_change_count := current_count + 1;
      NEW.dota_account_id_last_changed_at := NOW();
      
      -- Salva nello storico come 'change' (non 'initial')
      INSERT INTO public.player_id_history (
        user_id, 
        dota_account_id, 
        changed_from, 
        reason
      ) VALUES (
        NEW.id,
        NEW.dota_account_id,
        NULL, -- changed_from è NULL perché OLD era NULL
        'change' -- Ma è un cambio perché ha già impostato un ID prima
      );
      
      RETURN NEW;
    ELSE
      -- Prima impostazione mai: non conta come cambio
      NEW.dota_account_id_change_count := 0;
      NEW.dota_account_id_last_changed_at := NOW();
      
      -- Salva nello storico come 'initial'
      INSERT INTO public.player_id_history (
        user_id, 
        dota_account_id, 
        changed_from, 
        reason
      ) VALUES (
        NEW.id,
        NEW.dota_account_id,
        NULL,
        'initial'
      );
      
      RETURN NEW;
    END IF;
  END IF;

  -- Cambio normale (da valore a valore diverso)
  -- Controlla se è già bloccato
  IF OLD.dota_account_id_locked = TRUE THEN
    RAISE EXCEPTION 'Player ID è bloccato. Hai già cambiato 3 volte. Contatta il supporto per sbloccare.';
  END IF;

  -- Conta i cambi
  current_count := COALESCE(OLD.dota_account_id_change_count, 0);
  
  -- Se ha già fatto 3 cambi, blocca
  IF current_count >= 3 THEN
    NEW.dota_account_id_locked := TRUE;
    RAISE EXCEPTION 'Hai raggiunto il limite di 3 cambi Player ID. Contatta il supporto per sbloccare.';
  END IF;

  -- Incrementa contatore
  NEW.dota_account_id_change_count := current_count + 1;
  NEW.dota_account_id_last_changed_at := NOW();

  -- Salva nello storico
  INSERT INTO public.player_id_history (
    user_id, 
    dota_account_id, 
    changed_from, 
    reason
  ) VALUES (
    NEW.id,
    NEW.dota_account_id,
    OLD.dota_account_id,
    'change'
  );

  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Commento funzione aggiornato
COMMENT ON FUNCTION public.check_player_id_change_limit() IS 
  'Trigger function che verifica e applica il limite di 3 cambi Player ID per utente. Previene exploit di rimozione/reimpostazione.';

